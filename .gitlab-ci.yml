stages:
- prepare

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

prepare-secret:
  stage: prepare
  image: alpine:latest
  script:
  - apk add --no-cache bash coreutils gettext
  #######################  
  - export CLEAN_PWD=$(echo -n "$GITLAB_PSQL_PASSWORD" | tr -d '\r\n')
  - echo "$CLEAN_PWD"
  - echo -n "$CLEAN_PWD" | hexdump -C
  #####################
  - echo "üîê Encoding GITLAB_PSQL_PASSWORD..."
  - export POSTGRES_PASSWORD_B64=$(echo -n "$CLEAN_PWD" | base64 | tr -d '\n')
  - echo "‚úÖ Injecting password into secret.yaml"
  - envsubst < manifests/postgres/secret.template.yaml > manifests/postgres/secret.yaml
  - echo "üîç Generated secret.yaml:"
  - cat manifests/postgres/secret.yaml
  artifacts:
    paths:
    - manifests/postgres/secret.yaml
    expire_in: 1h
