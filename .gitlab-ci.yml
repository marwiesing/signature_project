stages:
- build

variables:
  IMAGE_NAME: "192.168.0.100:5050/homelab/signature_project"
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"

build:
  stage: build
  image: docker:24.0.7
  services:
  - name: docker:24.0.7-dind
    command: [ "--insecure-registry=192.168.0.100:5050" ]
  before_script:
  - echo "$GITLAB_REGISTRY_PASSWORD" | docker login -u "$GITLAB_REGISTRY_USER" --password-stdin "$GITLAB_REGISTRY_URL"
  script:
  - echo "üì¶ Building Docker image..."
  - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
  - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:latest
  - echo "Pushing Docker image to registry..."
  - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
  - docker push $IMAGE_NAME:latest
  ###################
  - echo "üîß Installing envsubst (gettext)..."
  - apk add --no-cache gettext
  - echo "üîê Generating Kubernetes Secret from template..."
  - envsubst < manifests/webapp/secret.yaml.template > manifests/webapp/secret.yaml
  - echo "‚úÖ Secret manifest ready for ArgoCD sync"
  ###################
  only:
  - main
