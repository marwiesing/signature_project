stages:
- test
- prepare
- deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "" # Disable Docker TLS
  GITLAB_PSQL_PASSWORD: $GITLAB_PSQL_PASSWORD

# --- Step 1: Your existing test runner (unchanged)
test-runner:
  stage: test
  image: docker:latest
  services:
  - name: docker:dind
    command:
    - "--tls=false"
    - "--insecure-registry=192.168.0.100:5050"
  before_script:
  - docker info
  - echo "$GITLAB_REGISTRY_PASSWORD" | docker login -u "$GITLAB_REGISTRY_USER" --password-stdin "$GITLAB_REGISTRY_URL" || exit 1
  script:
  - echo "âœ… GitLab Runner test successful!"

# --- Step 2: Inject and generate secret.yaml from template
prepare-secret:
  stage: prepare
  image: alpine:latest
  script:
  - apk add --no-cache bash coreutils gettext # ðŸŸ¢ add gettext here
  - echo -n "$GITLAB_PSQL_PASSWORD" | base64 > password.b64
  - export POSTGRES_PASSWORD_B64=$(cat password.b64)
  - envsubst < manifests/postgres/secret.template.yaml > manifests/postgres/secret.yaml
  - echo "âœ… secret.yaml generated"
  - cat manifests/postgres/secret.yaml
  artifacts:
    paths:
    - manifests/postgres/secret.yaml
    expire_in: 1h

# --- Step 3: Deploy secret.yaml to Kubernetes
deploy-secret:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
  - echo -n "$GITLAB_PSQL_PASSWORD" | base64 > password.b64
  - export POSTGRES_PASSWORD_B64=$(cat password.b64)
  - envsubst < manifests/postgres/secret.template.yaml > secret.yaml
  - kubectl apply -n chatbot -f secret.yaml
